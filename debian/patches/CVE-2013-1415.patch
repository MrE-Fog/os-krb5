From c773d3c775e9b2d88bcdff5f8a8ba88d7ec4e8ed Mon Sep 17 00:00:00 2001
From: Xi Wang <xi.wang@gmail.com>
Date: Thu, 14 Feb 2013 18:17:40 -0500
Subject: [PATCH] PKINIT null pointer deref [CVE-2013-1415]

Don't dereference a null pointer when cleaning up.

The KDC plugin for PKINIT can dereference a null pointer when a
malformed packet causes processing to terminate early, leading to
a crash of the KDC process.  An attacker would need to have a valid
PKINIT certificate or have observed a successful PKINIT authentication,
or an unauthenticated attacker could execute the attack if anonymous
PKINIT is enabled.

CVSSv2 vector: AV:N/AC:M/Au:N/C:N/I:N/A:C/E:P/RL:O/RC:C

This is a minimal commit for pullup; style fixes in a followup.
[kaduk@mit.edu: reformat and edit commit message]

ticket: 7570 (new)
target_version: 1.11.1
tags: pullup
---
 src/plugins/preauth/pkinit/pkinit_crypto_openssl.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

Index: krb5-1.10+dfsg~beta1/src/plugins/preauth/pkinit/pkinit_crypto_openssl.c
===================================================================
--- krb5-1.10+dfsg~beta1.orig/src/plugins/preauth/pkinit/pkinit_crypto_openssl.c	2014-08-07 15:35:19.407541455 -0400
+++ krb5-1.10+dfsg~beta1/src/plugins/preauth/pkinit/pkinit_crypto_openssl.c	2014-08-07 15:35:19.399541455 -0400
@@ -3242,7 +3242,7 @@
     pkiDebug("found kdcPkId in AS REQ\n");
     is = d2i_PKCS7_ISSUER_AND_SERIAL(NULL, &p, (int)pkid_len);
     if (is == NULL)
-        goto cleanup;
+        return retval;
 
     status = X509_NAME_cmp(X509_get_issuer_name(kdc_cert), is->issuer);
     if (!status) {
@@ -3252,7 +3252,6 @@
     }
 
     retval = 0;
-cleanup:
     X509_NAME_free(is->issuer);
     ASN1_INTEGER_free(is->serial);
     free(is);
