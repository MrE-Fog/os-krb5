From a197e92349a4aa2141b5dff12e9dd44c2a2166e3 Mon Sep 17 00:00:00 2001
From: Greg Hudson <ghudson@mit.edu>
Date: Sat, 27 Dec 2014 14:16:13 -0500
Subject: [PATCH] Fix kadm5/gssrpc XDR double free [CVE-2014-9421]

[MITKRB5-SA-2015-001] In auth_gssapi_unwrap_data(), do not free
partial deserialization results upon failure to deserialize.  This
responsibility belongs to the callers, svctcp_getargs() and
svcudp_getargs(); doing it in the unwrap function results in freeing
the results twice.

In xdr_krb5_tl_data() and xdr_krb5_principal(), null out the pointers
we are freeing, as other XDR functions such as xdr_bytes() and
xdr_string().

ticket: 8056 (new)
target_version: 1.13.1
tags: pullup
---
 src/lib/kadm5/kadm_rpc_xdr.c   | 2 ++
 src/lib/rpc/auth_gssapi_misc.c | 1 -
 2 files changed, 2 insertions(+), 1 deletion(-)

Index: krb5-1.10+dfsg~beta1/src/lib/kadm5/kadm_rpc_xdr.c
===================================================================
--- krb5-1.10+dfsg~beta1.orig/src/lib/kadm5/kadm_rpc_xdr.c	2015-02-06 15:35:12.444899861 -0500
+++ krb5-1.10+dfsg~beta1/src/lib/kadm5/kadm_rpc_xdr.c	2015-02-06 15:35:12.444899861 -0500
@@ -320,6 +320,7 @@
 	       free(tl);
 	       tl = tl2;
 	  }
+	  *tl_data_head = NULL;
 	  break;
 
      case XDR_ENCODE:
@@ -1067,6 +1068,7 @@
     case XDR_FREE:
 	if(*objp != NULL)
 	    krb5_free_principal(context, *objp);
+	*objp = NULL;
 	break;
     }
     return TRUE;
Index: krb5-1.10+dfsg~beta1/src/lib/rpc/auth_gssapi_misc.c
===================================================================
--- krb5-1.10+dfsg~beta1.orig/src/lib/rpc/auth_gssapi_misc.c	2015-02-06 15:35:12.444899861 -0500
+++ krb5-1.10+dfsg~beta1/src/lib/rpc/auth_gssapi_misc.c	2015-02-06 15:35:12.444899861 -0500
@@ -321,7 +321,6 @@
      if (! (*xdr_func)(&temp_xdrs, xdr_ptr)) {
 	  PRINTF(("gssapi_unwrap_data: deserializing arguments failed\n"));
 	  gss_release_buffer(minor, &out_buf);
-	  xdr_free(xdr_func, xdr_ptr);
 	  XDR_DESTROY(&temp_xdrs);
 	  return FALSE;
      }
